import {basename, extname, isAbsolute} from "node:path"
import {type ImageOptions} from "@11ty/eleventy-img"
import {modify} from "@onlyoffice/hast-util-eleventy-img"
import {generate} from "@onlyoffice/preact-eleventy-img"
import {useSuspense} from "@onlyoffice/preact-suspense"
import {type Root} from "hast"
import {type HTMLAttributes} from "preact/compat"
import {type JSX, h} from "preact"
import {visit} from "unist-util-visit"

export function Image(p: HTMLAttributes<HTMLImageElement>): JSX.Element {
  let r: JSX.Element | null = null

  // todo: this is a temporary solution during the migration.
  if (!p.alt) {
    p.alt = ""
  }

  let s = p.src
  if (!s || typeof s !== "string") {
    throw new Error("The 'src' attribute is required, but missing.")
  }

  if (!URL.canParse(s) && !isAbsolute(s)) {
    throw new Error("The 'src' attribute must be an absolute URL.")
  }

  if (isAbsolute(s)) {
    s = `.${s}`
  }

  // todo: this is a temporary solution during the migration.
  if (s.startsWith("./content")) {
    return null
  }

  const o = options(s)

  const Suspense = useSuspense(async () => {
    const c = <img decoding="async" loading="lazy" {...p} src={s} />
    r = await generate({...o, children: c})
  })

  return <Suspense>{() => r}</Suspense>
}

export function rehypeImage() {
  return async function (t: Root) {
    let r = Promise.resolve()

    visit(t, "element", (n, i, p) => {
      if (n.tagName !== "img") {
        return
      }

      // todo: this is a temporary solution during the migration.
      if (!n.properties.alt) {
        n.properties.alt = ""
      }

      const s = n.properties.src
      if (!s || typeof s !== "string") {
        throw new Error("The 'src' attribute is required, but missing.")
      }

      // todo: this is a temporary solution during the migration.
      if (s.startsWith("./content")) {
        return
      }

      const o = options(s)

      n.properties = {
        decoding: "async",
        loading: "lazy",
        ...n.properties,
      }

      // @ts-ignore conflict with mdx extensions
      r = modify(o, n, i, p)
    })

    await r
    return t
  }
}

function options(s: string): ImageOptions {
  const o: ImageOptions = {
    formats: ["jpg", "webp"],
    urlPath: "/assets/",
    outputDir: "dist/assets/",
    filenameFormat(id: string, s: string, w: number, f: string) {
      const e = extname(s)
      const n = basename(s, e)
      return `${n}-${w}w-${id}.${f}`
    }
  }

  const e = extname(s)
  if (e === ".svg") {
    o.formats = ["svg"]
  }

  return o
}
